---
title: 'dynsim: An R implementation of dynamic simulations of autoregressive relationships.'
author: Laron K Williams, Guy D Whitten, and [Christopher Gandrud](http://christophergandrud.blogspot.com/p/biocontact.html)
date: 1 March 2014
output:
  html_document:
    highlight: kate
    theme: spacelab
    toc: yes
---

Version 0.2.3

Fork it on [GitHub](https://github.com/christophergandrud/dynsim)

---

## About 

The **dynsim** package underdevelopment implements Williams and Whitten's ([2011](http://www.stata-journal.com/article.html?article=st0242), [2012](http://web.missouri.edu/~williamslaro/Williams%20and%20Whitten%202012.pdf)) method for dynamic simulations of autoregressive relationships in R.

## Process 

There are four basic steps to use **dynsim** to create dynamic simulations of autoregressive relationships:

1. *Estimate* your linear model using `zelig` from the [Zelig](http://gking.harvard.edu/zelig) package.

2. *Set up starting values* for simulation scenarios and (optionally) shock values at particular iterations (e.g. points in forecasted time).

3. *Simulate* these scenarios based on the estimated model using the `dynsim` function.

4. *Plot* the simulation results with the `dynsimGG` function.


## Examples

To see how dynsim works, let’s go through a few examples. We will use the Grunfeld (1958) data set. It is included with dynsim. 

First let's load the packages we will use:

```{r message=FALSE}
library(dynsim)
library(DataCombine)
library(Zelig)
```

Now let's load the data:

```{r}
data(grunfeld, package = 'dynsim')
```

The linear regression model we will estimate is:

\[I_{it} = \alpha + \beta_{1}I_{it-1} + \beta_{2}F_{it} + \beta_{3}C_{it} + \mu_{it} \]

where $I_{it}$ is real gross investment for firm $i$ in year $t$. $I_{it-1}$ is the firm's investment in the previous year. $F_{it}$ is the real value of the firm and $C_{it}$ is the real value of the capital stock.  

In the `grunfeld` data set real gross investment is denoted `invest`, the firm's market value is `mvalue`, and the capital stock is `kstock`. There are 10 large US manufacturers from 1935-1954 in the data set. The variable identifying the individual companies is called `company`. We can easily create the investment one-year lag using the `slide` command from the [DataCombine](https://github.com/christophergandrud/DataCombine) package. Here is the code:

```{r, message=FALSE}
grunfeld <- slide(grunfeld, Var = 'invest', GroupVar = 'company',
               NewVar = 'InvestLag')
```

The new lagged variable is called `InvestLag`.

### Dynamic simulation without shocks

Now that we have created our lag variable we, can begin to create dynamic simulations with **dynsim** by estimating the underlying linear regression model using **Zelig**, i.e.:

```{r, message=FALSE}
M1 <- zelig(invest ~ InvestLag + mvalue + kstock,
            model = 'ls', data = grunfeld, cite = FALSE)
```

We can use the resulting model object M1 in the dynsim command to run our dynamic simulations. We first need to create a list object containing data frames with starting values for each simulation scenario. Imagine we want to run three contrasting scenarios with the following fitted values:

- Scenario 1: mean lagged investment, market value and capital stock held at their 95th percentiles,

- Scenario 2: all variables held at their means,

- Scenario 3: mean lagged investment, market value and capital stock held at their 5th
percentiles.

We can create a list object for the scen argument containing each of these scenarios with the following code:

```{r message=FALSE}
# Create simulation scenarios
attach(grunfeld)
Scen1 <- data.frame(InvestLag = mean(InvestLag, na.rm = TRUE),
                    mvalue = quantile(mvalue, 0.95),
                    kstock = quantile(kstock, 0.95))
Scen2 <- data.frame(InvestLag = mean(InvestLag, na.rm = TRUE),
                    mvalue = mean(mvalue),
                    kstock = mean(kstock))
Scen3 <- data.frame(InvestLag = mean(InvestLag, na.rm = TRUE),
                    mvalue = quantile(mvalue, 0.05),
                    kstock = quantile(kstock, 0.05))
detach(grunfeld)
# Combine into a single list
ScenComb <- list(Scen1, Scen2, Scen3)
```

In this example we won’t introduce shocks, so now we run our simulations:

```{r}
Sim1 <- dynsim(obj = M1, ldv = 'InvestLag', scen = ScenComb, n = 20)
```

This took 1000 draws of the coefficients to produce 20 dynamic simulation iterations for each of the three scenarios. In the resulting `Sim1` object we have retained the middle 95% and 50%. We will return to presenting and exploring the contents of `Sim1` later in this section.

### Dynamic simulation with shocks

Now let’s include fitted shock values. In particular, let’s see how a company with capital stock in the 5th percentile is predicted to change its gross investment when its market value experiences shocks compared to a company with capital stock in the 95th percentile. We will use market values for the first company in the grunfeld data set over the first 15 years as the shock values. To create the shock data use the following code:

```{r, message=FALSE}
# Keep only the mvalue for the first company for the first 15 years
grunfeldsub <- subset(grunfeld, company == 1)
grunfeldshock <- grunfeldsub[1:15, 'mvalue']

# Create data frame for the shock argument
grunfeldshock <- data.frame(times = 1:15, mvalue = grunfeldshock)
```

Now we can simply add `grunfeldshock` to the dynsim shocks argument.

```{r}
Sim2 <- dynsim(obj = M1, ldv = 'InvestLag', scen = ScenComb, n = 15,
               shocks = grunfeldshock)
```

Now we can simply add grunfeldshock to the dynsim `shocks` argument.

```{r}
Sim3 <- dynsim(obj = M1, ldv = 'InvestLag', scen = ScenComb, n = 15,
               shocks = grunfeldshock)
```

### Plotting simulations

Probably the easiest and most effective way to communicate your dynsim simulation results is with the package’s built-in plotting capabilities. These are accessed with the `dysnsimGG` command. Let’s start by plotting the simulations from our basic model. In an earlier example we put these results into `Sim1`. Using `dynsimGG`'s default settings we can plot the simulations with the following code:

```{r fig.align='center'}
dynsimGG(Sim1)
```

We can make a number of aesthetic changes. For example, we can re-title the legend using the `leg.name` argument and change the legend values by adding a vector of the desired label names in the order of our scenarios using the `leg.labels` argument. We can also change the color palette using the `color` argument. Let’s use the 'orange-red' palette denoted by `OrRd`. Finally, we can change the y-axis label with the `ylab` argument so that it is more descriptive. 

```{r fig.align='center'}
# Create legend labels vector
Labels <- c('95th Percentile', 'Mean', '5th Percentile')
# Plot
dynsimGG(Sim1, leg.name = 'Scenarios', leg.labels = Labels, color = 'OrRd',
         ylab = 'Predicted Real Gross Investment\n')
```

Plotting simulations with shock variables is very similar to what we have already seen. The one major change we can make is to include a plot of one shock variable’s fitted values underneath the main plot. To do this simply use the `shockplot.var` argument to specify which variable to plot. Use the `shockplot.ylab` argument to change the y-axis label. For example:

```{r fig.align='center'}
dynsimGG(Sim2, leg.name = 'Scenarios', leg.labels = Labels, color = 'OrRd',
       ylab = 'Predicted Real Gross Investment\n', shockplot.var = 'mvalue',
       shockplot.ylab = 'Firm Value')
```

Similarly, we can plot the simulations from scenarios where market value shocks were interacted with capital stock. The code is accomplish this is almost identical to the code chunk we just saw. The only difference is that we use the `Sim3` model object.

```{r fig.align='center'}
dynsimGG(Sim3, leg.name = 'Scenarios', leg.labels = Labels, color = 'OrRd',
       ylab = 'Predicted Real Gross Investment\n', shockplot.var = 'mvalue',
       shockplot.ylab = 'Firm Value')
```

## Install

**dynsim** is available on [CRAN](http://cran.r-project.org/web/packages/dynsim/index.html)

You can also easily install the latest development version with the [devtools](http://cran.r-project.org/web/packages/devtools/index.html) package:

```{r eval=FALSE}
devtools::install_github('dynsim', 'christophergandrud')
```
